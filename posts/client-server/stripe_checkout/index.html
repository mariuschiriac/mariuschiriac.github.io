<!doctype html><html><head><title>Stripe payment React-Flask</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/assets/css/bootstrap.min.css><link rel=stylesheet href=/assets/css/layouts/main.css><link rel=stylesheet href=/assets/css/style.css><link rel=stylesheet href=/assets/css/navigators/navbar.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/assets/css/style.css><meta name=description content="Stripe payment React-Flask"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/assets/css/layouts/single.css><link rel=stylesheet href=/assets/css/navigators/sidebar.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-GL0HTQZQGK','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/main-logo.png>Marius Chiriac</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/main-logo.png class=d-none id=main-logo>
<img src=/images/inverted-logo.png class=d-none id=inverted-logo></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><input type=text placeholder=Search data-search id=search-box><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/client-server/>Client Server</a><ul class=active><li><a href=/posts/client-server/cookies/>Cookies in development</a></li><li><a href=/posts/client-server/migrate_js_ts/>Node: Migrate JS to TS</a></li><li><a class=active href=/posts/client-server/stripe_checkout/>Stripe payment React-Flask</a></li><li><a href=/posts/client-server/paypal_button/>Paypal payment React-Flask</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/react/>React</a><ul><li><a href=/posts/react/migrate_js_ts/>React: Migrate JS to TS</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/unity/>Unity</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/unity/design-patterns/>Design Patterns</a><ul><li><a href=/posts/unity/design-patterns/chain_of_responsibility/>Chain of Responsibility</a></li><li><a href=/posts/unity/design-patterns/command/>Command</a></li><li><a href=/posts/unity/design-patterns/object_pool/>Object Pool</a></li><li><a href=/posts/unity/design-patterns/component/>Component</a></li></ul></li><li><a href=/posts/unity/webgl_integration/>javascript in WEBGL build</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/unity/timeline/>Timeline</a><ul><li><a href=/posts/unity/timeline/dinamic-timeline/>Change timeline dinamically</a></li><li><a href=/posts/unity/timeline/concatenate/>Concatenate Timeline</a></li><li><a href=/posts/unity/timeline/base/>Unity Timeline</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://mariuschiriac.github.io/assets/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/avatar.png><h5 class=author-name>Marius Chiriac</h5><p>July 16, 2021</p></div><div class=title><h1>Stripe payment React-Flask</h1></div><div class=post-content id=post-content><h1 id=stripe-payment-react-flask>Stripe payment React-Flask</h1><h2 id=payment-flow>Payment Flow</h2><ol><li>User in the React site add items to cart</li><li>User navigate to cart page</li><li>User click on &ldquo;Pay with card&rdquo;</li><li>On user input React call the back-end passing cart and user data</li><li>Flask validate cart items throught database (pricing and availability)</li><li>Flask ask Stripe to create a checkout session, then send back session url to React</li><li>React redirect User to stripe checkout page</li><li>User perform payment using card</li><li>Stripe redirect User to success/failed url (the cart React page)</li><li>If payment success React empty cart and notify User</li><li>Stripe notify Flask throught webhook about payment completed with basical order info</li><li>Flask update database and React about buyed items</li></ol><img src=/images/client-server/stripe_flow.png class=center><h2 id=react-front-end>React (front-end)</h2><p>React functional with typescript.
In the following example it&rsquo;s implemented the front-end side of stripe checkout payment using <a href=https://redux-toolkit.js.org/rtk-query/overview>redux RTKQ</a></p><h3 id=modelspaymentts>models/Payment.ts</h3><pre><code>import { CartFootballer } from  './Footballer'; 
export  interface  CheckoutResponse {
checkout_url: string;
}
export  interface  CheckoutRequest {
cartFootballers: CartFootballer[];
email: string;
}
</code></pre><h3 id=apits>api.ts</h3><pre><code>import { createApi, fetchBaseQuery } from  '@reduxjs/toolkit/query/react';
import  Cookies  from  'js-cookie';
import { CheckoutRequest, CheckoutResponse } from  'models/Payment';
export  const  api = createApi({
baseQuery:  fetchBaseQuery({
baseUrl:  process.env.REACT_APP_API_URL,
credentials:  'include',
prepareHeaders: (headers, { getState }) =&gt; {
const  token = Cookies.get('csrf_access_token');
// If we have a token set in state, let's assume that we should be passing it.
if (token) headers.set('x-csrf-token', token);
return  headers;
},
}),
endpoints: (builder) =&gt; ({
stripeCheckout:  builder.mutation&lt;CheckoutResponse, CheckoutRequest&gt;({
query: (credentials) =&gt; ({
url:  'payment/createCheckoutSession',
method:  'POST',
body:  credentials,
}),
}),
paypalCheckout:  builder.mutation&lt;any, CheckoutRequest&gt;({
query: (credentials) =&gt; ({
url:  'payment/paypal/createCheckoutSession',
method:  'POST',
body:  credentials,
}),
}),
}),
});
export  const { useStripeCheckoutMutation, usePaypalCheckoutMutation } = api;
</code></pre><h3 id=carttsx>cart.tsx</h3><ul><li>On user input React call the back-end passing cart and user data <code>const response = await stripeCheckout(data).unwrap();</code></li><li>React redirect User to stripe checkout page <code>window.location.replace(response.checkout_url);</code></li><li>If payment success React empty cart and notify User <code>useEffect(() => {[...]}</code></li></ul><pre><code>import  React, { FC, useEffect } from  'react';
import  Item  from  './Item';
import { useCart } from  'services/cart';
import {useStripeCheckoutMutation,usePaypalCheckoutMutation} from  'redux/api';
import { CheckoutRequest } from  'models/Payment';
import { FUNDING, PayPalButtons } from  '@paypal/react-paypal-js';
const  App: FC = () =&gt; {
const { cart } = useCart();
const [stripeCheckout, { isLoading: stripeIsLoading }] =
useStripeCheckoutMutation();
const [paypalCheckout, { isLoading: paypalIsLoading }] =
usePaypalCheckoutMutation();
const  handleCheckout = async () =&gt; {
const  data: CheckoutRequest = {
cartFootballers:  cart,
email:  user?.email || '',
};
try {
const  response = await  stripeCheckout(data).unwrap();
window.location.replace(response.checkout_url);
} catch (error) {
console.log(error.response);
}
};
const  handlePaypalCheckoutComplete = async (data: any, actions: any) =&gt; {
try {
const  response = await  actions.order.capture();
console.log(response);
} catch (error) {
console.log(error.response);
}
};
const  handlePaypalCreateOrder = async (data: any, actions: any) =&gt; {
const  requestData: CheckoutRequest = {
cartFootballers:  cart,
email:  user?.email || '',
};
try {
const  response = await  paypalCheckout(requestData).unwrap();
console.log(response);
return  actions.order.create(response);
} catch (error) {
console.log(error.response);
}
return  '';
};
useEffect(() =&gt; {
// Check to see if this is a redirect back from Checkout
const  query = new  URLSearchParams(window.location.search);
if (query.get('success')) {
console.log('Order placed! You will receive an email confirmation.');
// empty cart and redirect to /cart
}
if (query.get('canceled'))
console.log('Order canceled -- continue to shop around');
}, [cart]);
return (
&lt;&gt;
{cart.length === 0 ? (
&lt;p&gt;empty cart&lt;/p&gt;
) : (
&lt;&gt;
&lt;div&gt;
{cart.map((cartFootballer, key) =&gt; (
&lt;Item
cartFootballer={cartFootballer.footballer}
quantity={cartFootballer.quantity}
key={key}
/&gt;
))}
&lt;/div&gt;
&lt;div&gt;
&lt;button  onClick={handleCheckout}&gt;Pay with card&lt;/button&gt;
&lt;PayPalButtons
createOrder={handlePaypalCreateOrder}
onApprove={handlePaypalCheckoutComplete}
fundingSource={FUNDING.PAYPAL}
style={{ height:  50, shape:  'pill' }}
&gt;&lt;/PayPalButtons&gt;
&lt;/div&gt;
&lt;/&gt;
)}
&lt;/&gt;
);
};
export  default  App;
</code></pre><h2 id=flask-back-end>Flask (back-end)</h2><p>the back-end needs 2 endpoint</p><ul><li>install stripe <code>pip install stripe</code></li><li>configure stripe</li></ul><pre><code>import  stripe
stripe.api_key = API.config[&quot;STRIPE_SK&quot;]
</code></pre><h3 id=create_checkout_session>create_checkout_session</h3><p>this endpoist is POST and have to:</p><ul><li>validate user data using database</li><li>check for item availability</li><li>create stripe checkout session</li><li>send to client the checkout page url</li></ul><p>create_checkout_session function:</p><pre><code>json_data = request.get_json(force=True)
[fbs, quantities] = parse_checkout_request(json_data)
email = json_data[&quot;email&quot;]
items = []
info_items = {&quot;items_number&quot;: len(fbs)}
for  i, fb  in  enumerate(fbs):
    items.append({
        &quot;price_data&quot;:{
            &quot;currency&quot;: &quot;eur&quot;,
            &quot;unit_amount&quot;: fb.price,
            &quot;product_data&quot;: {
                &quot;name&quot;: fb.name,
            },
        },
        &quot;quantity&quot;: quantities[i],
    })
    info_items[&quot;id&quot; + str(i)] = fb.id
    info_items[&quot;quantity&quot; + str(i)] = quantities[i]
try:
    checkout_session = stripe.checkout.Session.create(
    customer_email=email,
    payment_method_types=[&quot;card&quot;],
    line_items=items,
    mode=&quot;payment&quot;,
    success_url=API.config[&quot;BASE_URL_FRONT&quot;] + &quot;/cart?success=true&quot;,
    cancel_url=API.config[&quot;BASE_URL_FRONT&quot;] + &quot;/cart?canceled=true&quot;,
    metadata=info_items,
    )
except:
    raise  APIException(&quot;pagamento fallito&quot;)
return {&quot;checkout_url&quot;: checkout_session.url}
</code></pre><h3 id=stripe_checkout_webhook>stripe_checkout_webhook</h3><p>This endpoint will be called from stripe until he gets the response
It&rsquo;s very important to retrieve the stripe data with <code>request.data.decode("utf-8")</code>
This endpoist is POST and have to:</p><ul><li>verify that it is called from stripe webhook</li><li>verify that it isn&rsquo;t a dupplicate call or be idempotent</li><li>respond to stripe with status 200 as early as possible, the best is to respond just after the verification and launch another process to complete the task</li><li>fulfill order updating database and client</li></ul><p>stripe_checkout_webhook function:</p><pre><code>payload = request.data.decode(&quot;utf-8&quot;)
sig_header = request.headers[&quot;STRIPE_SIGNATURE&quot;]
event = None
try:
    event = stripe.Webhook.construct_event(
    payload, sig_header, API.config[&quot;STRIPE_WEBHOOK_KEY&quot;]
    )
except  ValueError  as  e:
    raise  APIException(&quot;Invalid payload&quot;)
except  stripe.error.SignatureVerificationError as  e:
    raise  APIException(&quot;Invalid signature&quot;)
if  event  is  None  or  event[&quot;type&quot;] != &quot;checkout.session.completed&quot;:
    raise  APIException(&quot;evento non consistente&quot;)
# check if event is not dupplicate
[...]
session = event[&quot;data&quot;][&quot;object&quot;]
email = session[&quot;customer_email&quot;]
items = session[&quot;metadata&quot;]
# update db and client
[...]
return {}
</code></pre><h2 id=stripe-config>Stripe config</h2><ol><li>create Stripe account</li><li>get secret key</li><li>create webhook</li><li>get webhook key</li></ol></div><div class=btn-improve-page><a href=https://github.com/mariuschiriac/mariuschiriac.github.io/edit/master/content/posts/client-server/stripe_checkout.md><i class="fas fa-code-branch"></i>Improve this page</a></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/client-server/paypal_button/ class="btn btn-outline-info"><span><i class="fas fa-chevron-circle-left"></i>Prev</span><br><span>Paypal payment React-Flask</span></a></div><div class="col-md-6 next-article"><a href=/posts/unity/timeline/concatenate/ class="btn btn-outline-info"><span>Next <i class="fas fa-chevron-circle-right"></i></span><br><span>Concatenate Timeline</span></a></div></div><hr></div></div></div></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#payment-flow>Payment Flow</a></li><li><a href=#react-front-end>React (front-end)</a><ul><li><a href=#modelspaymentts>models/Payment.ts</a></li><li><a href=#apits>api.ts</a></li><li><a href=#carttsx>cart.tsx</a></li></ul></li><li><a href=#flask-back-end>Flask (back-end)</a><ul><li><a href=#create_checkout_session>create_checkout_session</a></li><li><a href=#stripe_checkout_webhook>stripe_checkout_webhook</a></li></ul></li><li><a href=#stripe-config>Stripe config</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=#about>About</a></li><li class=nav-item><a class=smooth-scroll href=#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=#projects>Projects</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>redarked@gmail.com</span></li><li><span>Phone:</span> <span>+39 3880947809</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=#><img src=/assets/images/inverted-logo.png>
Toha</a></div><div class="col-md-4 text-center">© 2021 Marius Chiriac.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/>Powered by
<img src=/assets/images/hugo-logo-wide.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/assets/js/jquery-3.4.1.min.js></script><script src=/assets/js/popper.min.js></script><script src=/assets/js/bootstrap.min.js></script><script src=/assets/js/navbar.js></script><script src=/assets/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/assets/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>