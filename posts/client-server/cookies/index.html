<!doctype html><html><head><title>Cookies in development using localhost</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/assets/css/bootstrap.min.css><link rel=stylesheet href=/assets/css/layouts/main.css><link rel=stylesheet href=/assets/css/style.css><link rel=stylesheet href=/assets/css/navigators/navbar.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/assets/css/style.css><meta name=description content="Cookies in development using localhost"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/assets/css/layouts/single.css><link rel=stylesheet href=/assets/css/navigators/sidebar.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-GL0HTQZQGK','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/main-logo.png>Marius Chiriac</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/main-logo.png class=d-none id=main-logo>
<img src=/images/inverted-logo.png class=d-none id=inverted-logo></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><input type=text placeholder=Search data-search id=search-box><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/client-server/>Client Server</a><ul class=active><li><a class=active href=/posts/client-server/cookies/>Cookies in development</a></li><li><a href=/posts/client-server/migrate_js_ts/>Node: Migrate JS to TS</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/react/>React</a><ul><li><a href=/posts/react/migrate_js_ts/>React: Migrate JS to TS</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/unity/>Unity</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/unity/design-patterns/>Design Patterns</a><ul><li><a href=/posts/unity/design-patterns/chain_of_responsibility/>Chain of Responsibility</a></li><li><a href=/posts/unity/design-patterns/command/>Command</a></li><li><a href=/posts/unity/design-patterns/object_pool/>Object Pool</a></li><li><a href=/posts/unity/design-patterns/component/>Component</a></li></ul></li><li><a href=/posts/unity/webgl_integration/>javascript in WEBGL build</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/writing-posts/>Writing Posts</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/writing-posts/category/>Category</a><ul><li><a href=/posts/writing-posts/category/creating-category/>Creating Category</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/writing-posts/category/sub-category/>Sub-Category</a><ul><li><a href=/posts/writing-posts/category/sub-category/creating-sub-category/>Creating Sub-Category</a></li></ul></li></ul></li><li><a href=/posts/writing-posts/markdown-syntax-guide/>Markdown Guide</a></li><li><a href=/posts/writing-posts/using-emoji/>Using Emoji</a></li></ul></li><li><a href=/posts/analytics-and-comments/>Analytics & Comments</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://mariuschiriac.github.io/assets/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/avatar.png><h5 class=author-name>Marius Chiriac</h5><p>November 26, 2020</p></div><div class=title><h1>Cookies in development using localhost</h1></div><div class=post-content id=post-content><p>In this guide we will see how to config server backend with nodejs and exrepress to test cookies in localhost</p><hr><h2 id=keep-in-mind>Keep In Mind</h2><ul><li>cookies are created server-side</li><li>the client doesn&rsquo;t handle cookies</li><li>cookies are saved on the browser</li><li>server can read the cookies from the client request</li></ul><h2 id=setup-backend>Setup backend</h2><p><em>index.js</em></p><pre><code>const express = require('express');
const bodyParser = require('body-parser');
const webpush = require('web-push');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const https = require('https');
const fs = require('fs');

const Auth = require('./Auth');

const privateKey = fs.readFileSync('./certificates/key.pem', 'utf8');
const certificate = fs.readFileSync('./certificates/cert.pem', 'utf8');

const credentials = {
  key: privateKey,
  cert: certificate,
};


const app = express();

app.use(
  cors({
    origin: FRONT_HOST,
    credentials: true,
  })
);

app.use(bodyParser.json());
app.use(cookieParser());

app.post('/api/login', Auth.loginUser, Auth.silentLogin);
app.get('/api/silent_login', Auth.checkCookie, Auth.silentLogin);

const httpsServer = https.createServer(credentials, app);
  httpsServer.listen(3000, () =&gt; {
    console.log('online');
  });
</code></pre><p>Note that origin is not <code>*</code> (the wildcard), but one specify URL</p><p><em>auth.js</em></p><pre><code>const jwt = require('jsonwebtoken');

const secretCode = 'my-secret-code';
const cookieName = 'authData';

exports.checkCookie = async function (req, res, next) {
  try {
    if (!req.cookies[cookieName].token) {
      return res.status(401).send('cookie without token');
    }
    const decoded = await readToken(req.cookies[cookieName].token);
    /*
    [...]
    retrieve user data using id saved in the token and save it on req object
    */
    next();
  } catch (error) {
    return res.status(401).send();
  }
};

exports.silentLogin = async function (req, res) {
  try {
    return res.status(200).send({
      status: 1,  // logged in status
      user: req.user
    });
  } catch (error) {
    return res.status(400).send(error);
  }
};

//creates cookie without expiration time
exports.loginUser = async function (req, res, next) {
  if (!req.body.email || !req.body.password) {
    return res.status(400).send({ message: 'enter email and password' });
  }
  try {
    /*
    [...]
    check if email and password match in the users table
    retrieve id
    else return res.status(200).send({
      status: -1 // logged out
    });
    */
    //autenticathed

    createCookie(res, {
      userId: userData.id
    });

    req.user = userData;
    next();
  } catch (error) {
    return res.status(400).send(error);
  }
};

const createCookie = function (res, tokenData, { expireDate = null } = {}) {
  res.cookie(
    cookieName,
    {
      token: generateToken(tokenData),
      expires: expireDate ?? 0,
    },
    { httpOnly: true, secure: true }
  );
};

const generateToken = function (tokenData) {
  const token = jwt.sign(tokenData, secretCode, {});
  return token;
};

const readToken = async function (value) {
  return jwt.verify(value, secretCode);
};

</code></pre><h2 id=setup-cumputer>Setup cumputer</h2><ol><li>Change the URL of localhost (127.0.0.1) to another name, and replace it in the code in place of FRONT_HOST.</li></ol><p>That setup depends on which OS you have.</p><ol start=2><li>Specify FRONT_HOST as url where to run the client.</li></ol><h2 id=setup-client>Setup client</h2><p>the client&rsquo;s request header must have:</p><ul><li>withCredentials: true</li><li>&lsquo;Content-Type&rsquo;: &lsquo;application/json&rsquo;</li><li>&lsquo;Access-Control-Allow-Origin&rsquo;: location.origin</li></ul><h2 id=check>Check</h2><p>In order to check if cookies are saved correctly, we can firstly verify the network request where we call the login api, in the Header section we can see if header is correctly created.</p><img src=/images/cookie_1.png class=center><p>If it is, we can find the cookie in the Application tab under Storage/Cookies/FRONT_HOST</p></div><div class=btn-improve-page><a href=https://github.com/mariuschiriac/mariuschiriac.github.io/edit/master/content/posts/client-server/cookies.md><i class="fas fa-code-branch"></i>Improve this page</a></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/unity/webgl_integration/ class="btn btn-outline-info"><span><i class="fas fa-chevron-circle-left"></i>Prev</span><br><span>Integration of javascript in Unity WEBGL build</span></a></div><div class="col-md-6 next-article"><a href=/posts/writing-posts/category/creating-category/ class="btn btn-outline-info"><span>Next <i class="fas fa-chevron-circle-right"></i></span><br><span>Creating Category</span></a></div></div><hr></div></div></div></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#keep-in-mind>Keep In Mind</a></li><li><a href=#setup-backend>Setup backend</a></li><li><a href=#setup-cumputer>Setup cumputer</a></li><li><a href=#setup-client>Setup client</a></li><li><a href=#check>Check</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=#about>About</a></li><li class=nav-item><a class=smooth-scroll href=#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>redarked@gmail.com</span></li><li><span>Phone:</span> <span>+39 3880947809</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=#><img src=/assets/images/inverted-logo.png>
Toha</a></div><div class="col-md-4 text-center">© 2021 Marius Chiriac.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/>Powered by
<img src=/assets/images/hugo-logo-wide.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/assets/js/jquery-3.4.1.min.js></script><script src=/assets/js/popper.min.js></script><script src=/assets/js/bootstrap.min.js></script><script src=/assets/js/navbar.js></script><script src=/assets/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/assets/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>